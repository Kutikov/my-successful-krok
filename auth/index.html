<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>My successful KROK account</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <meta name="description" content="">
    <meta name="author" content="Damir A. Kutikov">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="User.js?id=123"></script>
    <script src="FireBaseAPI.js?id=123"></script>
    <script src="Background.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

</head>

<body>
    <div id="main"
        style="display: flex; bottom: 0; top: 0; right: 0; left: 0; position: absolute; flex-direction: column; align-items: center;">

        <canvas id='backgroundCanvas' class="canvasBackground"></canvas>
        <div id="panel-top" class="panel-top">
            <div id="icon"
                style="margin: 12px 8px 8px 12px; height: 32px; width: 32px; background-image: url('ic_launcher.png'); background-size: contain; flex-grow: 0; flex-shrink: 0;">
            </div>
            <p class="card__text" id="pageTitle"
                style="font-size: 22px; font-weight: 500; flex-grow: 1; margin-left: 16px;"></p>
            <div
                style="display: flex; flex-direction: row; margin-right: 8px; margin-left: 8px; flex-grow: 0; flex-shrink: 0; flex-wrap: nowrap;">
                <button class="button_local" style="margin: 8px" onclick="localize(0)">ua</button>
                <button class="button_local" style="margin: 8px" onclick="localize(2)">en</button>
                <button class="button_local" style="margin: 8px" onclick="localize(1)">ru</button>
            </div>
        </div>
        <div id="listMainPage" class="listMainPage">
            <div class='card' id="cardLogin">
                <div
                    style="display:flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-between; align-items: center;">
                    <p class="card__text" style="font-size: 22px;" id="loginingTitle">ВХІД</p>
                    <button class="button_local" style="margin: 8px 16px;" onclick="changeCard('register')"
                        id="registartionButtonB">
                        <i class="material-icons1 button__icon" aria-hidden="true">how_to_reg</i>
                        <span id="registartionButton">Реєстрація</span>
                    </button>
                </div>
                <label class="text_field__label" id="emailLoginH" style="margin: 8px 16px;">
                    <span class="notched-outline" id='emailLoginNotch'>
                        <span class="floating-label" id="emailLoginLabel">Email</span>
                    </span>
                    <input type="text" id="emailLogin" class="text-field__input" onblur="onBlur('emailLogin')" required
                        pattern="[-a-zA-Z0-9~!$%^&amp;*_=+}{'?]+(\.[-a-zA-Z0-9~!$%^&amp;*_=+}{'?]+)*@([a-zA-Z0-9_][-a-zA-Z0-9_]*(\.[-a-zA-Z0-9_]+)*\.([cC][oO][mM]))(:[0-9]{1,5})?">
                </label>
                <label class="text_field__label" id="passwordLoginH" style="margin: 8px 16px;">
                    <span class="notched-outline" id='passwordLoginNotch'>
                        <span class="floating-label" id="passwordLoginLabel">Пароль</span>
                    </span>
                    <input type="password" id="passwordLogin" class="text-field__input" onblur="onBlur('passwordLogin')"
                        required minlength="8">
                </label>
                <div role="progressbar" id="loginProgress" class="progress-bar">
                    <div class="progress-bar-value"></div>
                </div>
                <p class="card__text invalidC" id="consoleLogin" style="display: none;"></p>
                <div class="card__actions">
                    <button class="button_local__raised button_local " id="loginButtonB" onclick="loginIn()">
                        <span id='loginButton'>Увійти</span>
                    </button>
                    <button class="button_local" id="resetButtonB" onclick="resetPass()">
                        <span id='resetButton'>Скинути пароль</span>
                    </button>
                </div>
            </div>
            <div class='card' id="cardRegister">
                <div
                    style="display:flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-between; align-items: center;">
                    <p class="card__text" style="font-size: 22px;" id="registartionTitle">РЕЄСТРАЦІЯ</p>
                    <button class="button_local" onclick="changeCard('login')" style="margin: 8px 16px;"
                        id="loginingButtonB">
                        <i class="material-icons1 button__icon" aria-hidden="true">vpn_key</i>
                        <span id="loginingButton">Вхід</span>
                    </button>
                </div>
                <label class="text_field__label" id="nameRegisterH" style="margin: 8px 16px;">
                    <span class="notched-outline" id='nameRegisterNotch'>
                        <span class="floating-label" id="nameRegisterLabel">nnn</span>
                    </span>
                    <input type="text" id="nameRegister" class="text-field__input" onblur="onBlur('nameRegister')"
                        required minlength="4">
                </label>
                <label class="text_field__label" id="emailRegisterH" style="margin: 8px 16px;">
                    <span class="notched-outline" id='emailRegisterNotch'>
                        <span class="floating-label" id="emailRegisterLabel">Email</span>
                    </span>
                    <input type="text" id="emailRegister" class="text-field__input" onblur="onBlur('emailRegister')"
                        required
                        pattern="[-a-zA-Z0-9~!$%^&amp;*_=+}{'?]+(\.[-a-zA-Z0-9~!$%^&amp;*_=+}{'?]+)*@([a-zA-Z0-9_][-a-zA-Z0-9_]*(\.[-a-zA-Z0-9_]+)*\.([cC][oO][mM]))(:[0-9]{1,5})?">
                </label>
                <label class="text_field__label" id="passwordRegister1H" style="margin: 8px 16px;">
                    <span class="notched-outline" id='passwordRegister1Notch'>
                        <span class="floating-label" id="passwordRegister1Label">Пароль</span>
                    </span>
                    <input type="password" id="passwordRegister1" class="text-field__input"
                        onblur="onBlur('passwordRegister1')" required minlength="8">
                </label>
                <label class="text_field__label" id="passwordRegister2H" style="margin: 8px 16px;">
                    <span class="notched-outline" id='passwordRegister2Notch'>
                        <span class="floating-label" id="passwordRegister2Label">Повторити пароль</span>
                    </span>
                    <input type="password" id="passwordRegister2" class="text-field__input"
                        onblur="onBlur('passwordRegister2')" required minlength="8">
                </label>
                <label class="pure-material-checkbox" style="margin: 0 16px;">
                    <input type="checkbox" id="checkboxConsent" />
                    <span id="checkboxConsentLabel">Я погоджуюся з <a target="_blank"
                            href="https://google.com.ua">правилами користування</a> цього додатку</span>
                </label>
                <div role="progressbar" id="registerProgress" class="progress-bar">
                    <div class="progress-bar-value"></div>
                </div>
                <p class="card__text invalidC" id="consoleRegister" style="display: none;"></p>
                <div class="card__actions">
                    <button class="button_local__raised button_local " id="registerButtonB" onclick="register()">
                        <span id='registerButton'>Зареєструватися</span>
                    </button>
                </div>
            </div>
            <div class='card' id="cardSuccess">
                <div style="display: flex; flex-direction: column; margin: 16px; align-items: center;">
                    <div class="image_invert"
                        style="height: 256px; width: 256px; background-image: url('success.jpg'); background-size: contain;">
                    </div>
                    <p class="card__text message__text" id="successfulTitle"
                        style="width: 100%; text-align: center; font-size: 22px; font-weight: 600;"></p>
                    <p class="card__text messageText" id="consoleSuccess" style="width: 100%; text-align: justify;">
                    </p>
                </div>
            </div>
            <div class='card' id="cardLoading">
                <div style="display: flex; flex-direction: column; margin: 16px; align-items: center;">
                    <div class="image_invert"
                        style="height: 256px; width: 256px; background-image: url('wait.jpg'); background-size: contain;">
                    </div>
                    <p class="card__text message__text" id="loadingTitle"
                        style="width: 100%; text-align: center; font-size: 22px; font-weight: 600;"></p>
                </div>
            </div>
        </div>
        <div class="canvasBackground dialogHolder" style="display: none;" id="dialogHolder">
            <div class="dialog card">
                <table>
                    <tr>
                        <td style="width: 90%; vertical-align: middle;">
                            <p class="card__text" id="consentTitle" style="font-size: 22px; font-weight: 600;"></p>
                        </td>
                        <td style="vertical-align: top; text-align: end;">
                            <i class="material-icons1" aria-hidden="true"
                                style="font-size: 36px; margin: 8px;cursor: pointer;" onclick="dialogC(false)">close</i>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <div style="overflow-x: hidden; overflow-y: visible; max-height: 500px;">
                                <p class="card__text" id="consentText"></p>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const localization = {
            consentTitle: ['Згода користувача', "Пользовательское соглашение", 'User`s consent'],
            consentText: ['Згода користувача', "Пользовательское соглашение", 'User`s consent'],
            loginingTitle: ['ВХІД', 'ВХОД', 'SIGNING IN'],
            registartionButton: ['Реєстрація', 'Регистрация', 'Registration'],
            emailLoginLabel: ['Email', 'Email', 'Email'],
            passwordLoginLabel: ['Пароль', 'Пароль', 'Password'],
            loginButton: ['Увійти', 'Войти', 'Sign in'],
            resetButton: ['Скинути пароль', 'Сбросить пароль', 'Reset password'],
            registartionTitle: ['РЕЄСТРАЦІЯ', 'РЕГИСТРАЦИЯ', 'REGISTRATION'],
            loginingButton: ['Вхід', 'Вход', 'Signing in'],
            nameRegisterLabel: ['Ім\'я у додатку', 'Имя в приложении', 'Name in app'],
            emailRegisterLabel: ['Email', 'Email', 'Email'],
            passwordRegister1Label: ['Пароль (8 знаків)', 'Пароль (8 знаков)', 'Password (8 symbols)'],
            passwordRegister2Label: ['Повторити пароль', 'Повторить пароль', 'Repeat password'],
            checkboxConsentLabel: ['Я погоджуюся з <a href="javascript:dialogC(true)">правилами користування</a> цього додатку', 'Я соглашаюсь с <a href="javascript:dialogC(true)">правилами пользования</a> этого приложения', 'I agree to the <a href="javascript:dialogC(true)">terms of use</a> for this application'],
            registerButton: ['Зареєструватися', 'Зарегистрироваться', 'Register'],
            pageTitle: ['Мій успішний КРОК', 'Мой успешный КРОК', 'My successful KROK'],
            successfulTitle: ['Успішно!', 'Успешно!', 'Successfully!'],
            loadingTitle: ['Будь ласка, зачекайте, йде ініціалізація...', 'Пожалуйста, подождите, идет инициализация...', 'Please wait, initialization...']
        };

        const messages = {
            emptyName: ['Некоректне ім\'я', 'Некорректное имя', 'Incorrect name'],/*+*/
            needVerification: ['Вам на пошту надійшов лист з посиланням для підтверждення реєстрації. Відкрийте його та натисніть на посилання.', 'Вам на почту пришло письмо со ссылкой для подтверждения регистрации. Откройте его и нажмите на ссылку.', 'You have received an email with a link to confirm registration. Open it and click on the link.'],/*+*/
            weakPassword: ["Пароль недостатньо надійний", 'Пароль недостаточно надежен', 'The password is not strong enough'],/*-*/
            duplicateEmail: ["Користувач з такою email адресою вже зареєстрований", 'Пользователь с таким email адресу уже зарегистрирован', 'A user with this email address is already registered'],/*+*/
            emptyEmail: ["Некоректний email", 'Некорректный email', 'Incorrect email'],/*+*/
            logedIn: ["Ви успішно увійшли в акаунт! Не забудьте також увійти на Ваших 2 пристроях з додатком Мій успішний КРОК.", 'Вы успешно вошли в аккаунт! Не забудьте также войти на Ваших 2 устройствах с приложением Мой успешный КРОК.', 'You have successfully logged in! Don\'t forget to sign in on your 2 devices with the My Successful KROK app.'],/*+*/
            wrongPassword: ["Невірний пароль", 'Неверный пароль', 'Invalid password'],/*+*/
            notFoundEmail: ["Користувача з такою поштою не знайдено", 'Пользователя с таким почте не найдено', 'No user with this mail was found'],/*+*/
            expiredTermReresetPass: ["Нажаль вийшов термін коду скидання пароля, скиньте пароль іще раз", 'К сожалению вышел срок кода сброса пароля, сбросьте пароль еще раз', 'Sorry, the password reset code has expired, reset your password again'],/*+*/
            passwordEmailSended: ["Вам надіслано на пошту лист з посиланням для скидання пароля. Відкрийте його та натисніть на посилання.", 'Вам отправлено на почту письмо со ссылкой для сброса пароля. Откройте его и нажмите на ссылку.', 'You have received an email with a link to reset your password. Open it and click on the link.'],/*+*/
            enterNewPassword: ["Введіть новий пароль", 'Введите новий пароль', 'Enter a new password'],/*+*/
            emailVerified: ["Вашу пошту підтвержено! Тепер Ви маєте повний доступ до всієї платформи. Не забудьте також увійти на Ваших 2 пристроях з додатком Мій успішний КРОК.", 'Почта подтверждена! Теперь Вы имеете полный доступ ко всей платформы. Не забудьте также войти на Ваших 2 устройствах с приложением Мой успешный КРОК.', 'Your mail has been confirmed! You now have full access to the entire platform. Don\'t forget to sign in on your 2 devices with the My Successful KROK app.'],
            emptyPassword: ["Некоректний пароль", 'Некорректный пароль', 'Incorrect password'],/*+*/
            emptyPassword2: ["Некоректно повторений пароль", 'Некорректно повторен пароль', 'Incorrectly repeated password'],/*+*/
            passwordMismatch: ["Паролі не співпадають", 'Пароли не совпадают', 'Passwords do not match'],/*+*/
            agreeConsent: ["Підтвердьте, що згодні з умовами користування додатком", 'Подтвердите, что согласны с условиями пользования приложением', 'Confirm that you agree to the terms of use of the application']/*+*/
        };

        let message = ''
        let lang = 0;
        let updatePassword = false;
        const loginCard = document.getElementById('cardLogin');
        const registerCard = document.getElementById('cardRegister');
        const successCard = document.getElementById('cardSuccess');
        const loadingCard = document.getElementById('cardLoading');
        const loginConsole = document.getElementById('consoleLogin');
        const registerConsole = document.getElementById('consoleRegister');
        const successConsole = document.getElementById('consoleSuccess');
        const loadingConsole = document.getElementById('loadingSuccess');
        const background = new Background();

        changeCard('loading');
        const firebaseApi = new FireBaseAPI();


        window.addEventListener('resize', (e) => {
            background.drawBackground();
        });

        document.addEventListener('DOMContentLoaded', () => {
            let langI = 0;
            switch (new URLSearchParams(window.location.search).get('language')) {
                case 'ru':
                    langI = 1;
                    break;
                case 'en':
                    langI = 2;
                    break;
                case 'ua':
                    langI = 0;
                    break;
            }
            localize(langI);
            if (new URLSearchParams(window.location.search).get('theme') == 'dark') {
                const link = document.createElement('link');
                link.setAttribute('rel', 'stylesheet');
                link.setAttribute('href', 'style-dark.css');
                document.head.append(link);
                background.setDark();
            }
            else {
                background.setLight();
            }
        });

        function onBlur(id) {
            if (!document.querySelector('#' + id).checkValidity()) {
                document.querySelector('#' + id + 'Notch').classList.add('invalidC');
                document.querySelector('#' + id + 'Label').classList.add('invalidC');
            }
            else {
                document.querySelector('#' + id + 'Notch').classList.remove('invalidC');
                document.querySelector('#' + id + 'Label').classList.remove('invalidC');
            }
        }

        function localize(langInt) {
            lang = langInt;
            for (let str in localization) {
                document.getElementById(str).innerHTML = localization[str][lang];
            }
            if (message !== '') {
                showMessage(message);
            }
        }

        function verifyField(id) {
            if (!document.getElementById(id).classList.contains('mdc-text-field--invalid')) {
                return document.getElementById(id.substring(0, id.length - 1)).value;
            }
            return false;
        }

        function dialogC(open) {
            document.getElementById('dialogHolder').style.display = open ? 'flex' : 'none';
        }

        function loginIn() {
            const email = verifyField('emailLoginH');
            const password = verifyField('passwordLoginH');
            if (!email) {
                showMessage('emptyEmail');
                return;
            }
            if (!password) {
                showMessage('emptyPassword');
                return;
            }
            firebaseApi.login(email, password);
            document.getElementById('registartionButtonB').disabled = true;
            document.getElementById('loginButtonB').disabled = true;
            document.getElementById('resetButtonB').disabled = true;
            document.getElementById('loginProgress').style.display = 'block';
        }

        function resetPass() {
            const email = verifyField('emailLoginH');
            const password = verifyField('passwordLoginH');
            if (!email) {
                showMessage('emptyEmail');
                return;
            }
            if (!password && updatePassword) {
                showMessage('emptyPassword');
                return;
            }
            firebaseApi.resetPass(email, password, updatePassword);
            document.getElementById('registartionButtonB').disabled = true;
            document.getElementById('loginButtonB').disabled = true;
            document.getElementById('resetButtonB').disabled = true;
            document.getElementById('loginProgress').style.display = 'block';
        }

        function register() {
            const name = verifyField('nameRegisterH');
            const email = verifyField('emailRegisterH');
            const password1 = verifyField('passwordRegister1H');
            const password2 = verifyField('passwordRegister2H');
            if (!name) {
                showMessage('emptyName');
                return;
            }
            if (!email) {
                showMessage('emptyEmail');
                return;
            }
            if (!password1) {
                showMessage('emptyPassword');
                return;
            }
            if (!password2) {
                showMessage('emptyPassword');
                return;
            }
            if (password1 !== password2) {
                showMessage('passwordMismatch');
                return;
            }
            if (!document.getElementById('checkboxConsent').checked) {
                showMessage('agreeConsent');
                return;
            }
            firebaseApi.register(email, password1, name);
            document.getElementById('loginingButtonB').disabled = true;
            document.getElementById('registerButtonB').disabled = true;
            document.getElementById('registerProgress').style.display = 'block';
        }

        function showMessage(message1, prevent = false) {
            message = message1;
            loginConsole.style.display = 'block';
            successConsole.style.display = 'block';
            registerConsole.style.display = 'block';
            document.getElementById('loginProgress').style.display = 'none';
            document.getElementById('registerProgress').style.display = 'none';
            loginConsole.innerHTML = messages[message][lang];
            successConsole.innerHTML = messages[message][lang];
            registerConsole.innerHTML = messages[message][lang];
            if (!prevent) {
                document.getElementById('registartionButtonB').disabled = false;
                document.getElementById('loginButtonB').disabled = false;
                document.getElementById('resetButtonB').disabled = false;
            }
        }

        function changeCard(type) {
            message = '';
            loginCard.style.display = 'none';
            successCard.style.display = 'none';
            registerCard.style.display = 'none';
            loadingCard.style.display = 'none';
            loginConsole.style.display = 'none';
            successConsole.style.display = 'none';
            registerConsole.style.display = 'none';
            document.getElementById('loginProgress').style.display = 'none';
            document.getElementById('registerProgress').style.display = 'none';
            switch (type) {
                case 'loading':
                    loadingCard.style.display = 'flex';
                    break;
                case 'register':
                    registerCard.style.display = 'flex';
                    break;
                case 'login':
                    loginCard.style.display = 'flex';
                    break;
                case 'success':
                    successCard.style.display = 'flex';
                    break;
            }
            interactionInterface('loaded');
        }

        function interactionInterface(message) {
            if (typeof android !== 'undefined') {
                android.onMessageRecieved(message);
            }
            else {
                console.log(message);
            }
        }
    </script>
</body>

</html>